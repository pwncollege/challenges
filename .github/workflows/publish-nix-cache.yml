name: Publish Nix Cache

on:
  push:
    branches: [ main ]
    paths:
      - flake.nix
      - flake.lock
      - runtime/**
      - tools/pwnshop/**
  workflow_dispatch:

concurrency:
  group: publish-nix-cache-${{ github.ref }}
  cancel-in-progress: true

jobs:
  publish-dev-shell-cache:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    env:
      R2_BUCKET_NAME: challenges-nix-cache
      R2_PUBLIC_CACHE_DOMAIN: nix-cache.challenges.pwn.college
      R2_ENDPOINT: ${{ secrets.R2_ACCOUNT_ID }}.r2.cloudflarestorage.com
      AWS_PROFILE_NAME: default
    steps:
    - uses: actions/checkout@v4
    - uses: DeterminateSystems/nix-installer-action@main
    - uses: DeterminateSystems/magic-nix-cache-action@main
    - name: Build dev shell
      id: build-dev-shell
      run: |
        set -euo pipefail
        printf 'path=%s\n' "$(nix build --accept-flake-config --no-link --print-out-paths .#devShells.x86_64-linux.default)" >> "${GITHUB_OUTPUT}"

    - name: Sign dev shell closure
      env:
        NIX_CACHE_PRIVATE_KEY: ${{ secrets.NIX_CACHE_PRIVATE_KEY }}
      run: |
        set -euo pipefail
        nix_cache_private_key="${RUNNER_TEMP}/nix-cache-private-key"
        # shellcheck disable=SC2153
        printf '%s\n' "${NIX_CACHE_PRIVATE_KEY}" > "${nix_cache_private_key}"
        chmod 600 "${nix_cache_private_key}"
        nix store sign --recursive --key-file "${nix_cache_private_key}" '${{ steps.build-dev-shell.outputs.path }}'

    - name: Configure AWS credentials
      env:
        AWS_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY }}
        AWS_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_KEY }}
      run: |
        set -euo pipefail
        nix shell nixpkgs#awscli --command aws configure set aws_access_key_id "${AWS_ACCESS_KEY_ID}" --profile "${AWS_PROFILE_NAME}"
        nix shell nixpkgs#awscli --command aws configure set aws_secret_access_key "${AWS_SECRET_ACCESS_KEY}" --profile "${AWS_PROFILE_NAME}"

    - name: Publish dev shell closure to R2 cache
      run: |
        set -euo pipefail
        nix copy --to "s3://${R2_BUCKET_NAME}?profile=${AWS_PROFILE_NAME}&endpoint=${R2_ENDPOINT}&compression=zstd" '${{ steps.build-dev-shell.outputs.path }}'

    - name: Check cache availability from public domain
      run: |
        set -euo pipefail
        nix path-info --store "https://${R2_PUBLIC_CACHE_DOMAIN}" '${{ steps.build-dev-shell.outputs.path }}' >/dev/null
