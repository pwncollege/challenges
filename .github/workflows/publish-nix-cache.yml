name: Publish Nix Cache

on:
  push:
    branches: [ main ]
    paths:
      - flake.nix
      - flake.lock
      - runtime/**
      - tools/pwnshop/**
  workflow_dispatch:

concurrency:
  group: publish-nix-cache-${{ github.ref }}
  cancel-in-progress: true

jobs:
  publish-devshell-cache:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    env:
      R2_BUCKET_NAME: challenges-nix-cache
      R2_PUBLIC_CACHE_DOMAIN: nix-cache.challenges.pwn.college
      R2_ENDPOINT: ${{ secrets.R2_ACCOUNT_ID }}.r2.cloudflarestorage.com
    steps:
    - uses: actions/checkout@v4

    - name: Install Nix
      uses: DeterminateSystems/determinate-nix-action@v3

    - name: Enable Magic Nix Cache
      uses: DeterminateSystems/magic-nix-cache-action@v13

    - name: Build dev shell output
      id: resolve-devshell-out
      run: |
        set -euo pipefail
        printf 'path=%s\n' "$(nix build --no-link --print-out-paths .#devShells.x86_64-linux.default)" >> "${GITHUB_OUTPUT}"

    - name: Publish dev shell closure to R2 cache
      env:
        AWS_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY }}
        AWS_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_KEY }}
        AWS_REGION: auto
        AWS_DEFAULT_REGION: auto
        AWS_EC2_METADATA_DISABLED: "true"
        NIX_CACHE_SIGNING_PRIVATE_KEY: ${{ secrets.NIX_CACHE_SIGNING_PRIVATE_KEY }}
      run: |
        set -euo pipefail

        if [[ -z "${NIX_CACHE_SIGNING_PRIVATE_KEY}" ]]; then
          echo "Missing required secret: NIX_CACHE_SIGNING_PRIVATE_KEY" >&2
          exit 1
        fi

        signing_key_file="${RUNNER_TEMP}/nix-cache-private-key"
        printf '%s\n' "${NIX_CACHE_SIGNING_PRIVATE_KEY}" > "${signing_key_file}"
        chmod 600 "${signing_key_file}"

        cache_store="s3://${R2_BUCKET_NAME}?scheme=https&endpoint=${R2_ENDPOINT}&region=auto&secret-key=${signing_key_file}"
        devshell_out='${{ steps.resolve-devshell-out.outputs.path }}'

        nix copy --to "${cache_store}" "${devshell_out}"

    - name: Check cache availability from public domain
      run: |
        set -euo pipefail
        devshell_out='${{ steps.resolve-devshell-out.outputs.path }}'
        nix path-info --store "https://${R2_PUBLIC_CACHE_DOMAIN}" "${devshell_out}" >/dev/null
