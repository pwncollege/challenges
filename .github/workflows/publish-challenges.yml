name: Publish Challenges

on:
  push:
    branches: [ main ]
  workflow_dispatch:

concurrency:
  group: publish-challenges-${{ github.ref }}
  cancel-in-progress: true

jobs:
  determine-modified-challenges:
    runs-on: ubuntu-latest
    outputs:
      challenges: ${{ steps.determine-modified-challenges.outputs.challenges }}
      modified_since_ref: ${{ steps.determine-modified-challenges.outputs.modified_since_ref }}
    steps:
    - uses: actions/checkout@v4

    - name: Determine modified challenges
      id: determine-modified-challenges
      uses: ./.github/actions/determine-modified-challenges


  publish:
    needs: determine-modified-challenges
    if: ${{ needs.determine-modified-challenges.outputs.challenges != '[]' }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        challenges: ${{ fromJson(needs.determine-modified-challenges.outputs.challenges) }}
    steps:
    - uses: actions/checkout@v4

    - name: Login to registry
      if: false
      uses: docker/login-action@v3
      with:
        registry: ${{ secrets.REGISTRY_HOST }}
        username: ${{ secrets.REGISTRY_USER }}
        password: ${{ secrets.REGISTRY_PASSWORD }}

    - name: Set up Docker storage
      uses: ./.github/actions/setup-docker-storage

    - name: Set up Docker
      uses: docker/setup-buildx-action@v3

    - name: Test challenges
      uses: ./.github/actions/test-challenges
      with:
        challenges: ${{ matrix.challenges }}
        modified_since_ref: ""

    - name: Publish challenges
      env:
        CHALLENGES_DIR: challenges/${{ matrix.challenges }}
      run: |
        set -euo pipefail
        containerd_blobs_dir="/var/lib/containerd/io.containerd.content.v1.content/blobs/sha256"
        publish_blobs_dir="/mnt/publish/blobs"
        publish_manifests_dir="/mnt/publish/manifets"
        sudo mkdir -p "$publish_blobs_dir" "$publish_manifests_dir"
        while IFS= read -r challenge; do
          image_id="$(./pwnshop build "$CHALLENGES_DIR/$challenge")"
          image_id="${image_id#sha256:}"
          challenge_slug="${CHALLENGES_DIR#challenges/}/$challenge"
          stack=("$image_id")
          while ((${#stack[@]})); do
            digest="${stack[-1]}"
            unset 'stack[-1]'
            sudo ln "$containerd_blobs_dir/$digest" "$publish_blobs_dir/$digest" 2>/dev/null || true
            mapfile -t -O "${#stack[@]}" stack < <(
              sudo jq -r '.manifests[]?.digest,.config.digest?,.layers[]?.digest? | select(type=="string") | sub("^sha256:";"")' \
                "$containerd_blobs_dir/$digest" 2>/dev/null
            )
          done
          manifest_dir="$publish_manifests_dir/$challenge_slug"
          sudo mkdir -p "$manifest_dir"
          sudo ln -sfn "$publish_blobs_dir/$image_id" "$manifest_dir/latest"

        done < <(./pwnshop list "$CHALLENGES_DIR")
        echo "::group::Publish manifests"
        find "$publish_manifests_dir" -type l -print0 | sort -z | xargs -0 -I{} sh -c 'printf "%s -> %s\n" "{}" "$(readlink "{}")"'
        echo "::endgroup::"
        echo "::group::Publish blob storage"
        du -sh "$publish_blobs_dir"
        echo "::endgroup::"

    - name: Report docker storage
      if: always()
      uses: ./.github/actions/report-docker-storage
