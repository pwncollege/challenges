name: Publish Challenges

on:
  push:
    branches: [ main ]
  workflow_dispatch:

concurrency:
  group: publish-challenges-${{ github.ref }}
  cancel-in-progress: true

jobs:
  determine-modified-challenges:
    runs-on: ubuntu-latest
    outputs:
      challenges: ${{ steps.determine-modified-challenges.outputs.challenges }}
      modified_since_ref: ${{ steps.determine-modified-challenges.outputs.modified_since_ref }}
    steps:
    - uses: actions/checkout@v4

    - name: Determine modified challenges
      id: determine-modified-challenges
      uses: ./.github/actions/determine-modified-challenges


  publish:
    needs: determine-modified-challenges
    if: ${{ needs.determine-modified-challenges.outputs.challenges != '[]' }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        challenges: ${{ fromJson(needs.determine-modified-challenges.outputs.challenges) }}
    steps:
    - uses: actions/checkout@v4
    - uses: DeterminateSystems/determinate-nix-action@v3.14.0
    - uses: DeterminateSystems/flakehub-cache-action@v3.15.2

    - name: Move storage
      uses: ./.github/actions/move-runtime-storage

    - name: Install uv
      uses: astral-sh/setup-uv@v7
      with:
        cache-dependency-glob: tools/dojo/**

    - name: Test challenges
      uses: ./.github/actions/test-challenges
      with:
        challenges: ${{ matrix.challenges }}
        modified_since_ref: ""

    - name: Install rclone
      run: sudo apt-get update && sudo apt-get install -y rclone

    - name: Publish challenges
      shell: 'nix develop -c bash -euo pipefail {0}'
      env:
        CHALLENGES_DIR: challenges/${{ matrix.challenges }}
        R2_BUCKET_NAME: challenges-registry
        RCLONE_CONFIG_R2_TYPE: s3
        RCLONE_CONFIG_R2_PROVIDER: Cloudflare
        RCLONE_CONFIG_R2_ENDPOINT: https://${{ secrets.R2_ACCOUNT_ID }}.r2.cloudflarestorage.com
        RCLONE_CONFIG_R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY }}
        RCLONE_CONFIG_R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_KEY }}
      run: |
        containerd_blobs_dir="$(docker info --format '{{.DockerRootDir}}')/containerd/daemon/io.containerd.content.v1.content/blobs"
        publish_blobs_dir="/mnt/publish/blobs"
        publish_manifests_dir="/mnt/publish/manifests"
        sudo mkdir -p "$publish_blobs_dir" "$publish_manifests_dir"
        while IFS= read -r line; do
          image_id="${line%% *}"
          challenge_slug="${line#* }"
          stack=("$image_id")
          while ((${#stack[@]})); do
            digest="${stack[-1]}"
            digest_path="${digest//:/\/}"
            unset 'stack[-1]'
            sudo mkdir -p "$publish_blobs_dir/${digest_path%%/*}"
            sudo ln "$containerd_blobs_dir/$digest_path" "$publish_blobs_dir/$digest_path" 2>/dev/null || continue
            mapfile -t -O "${#stack[@]}" stack < <(
              sudo jq -r '.manifests[]?.digest,.config.digest?,.layers[]?.digest? | select(type=="string")' \
                "$containerd_blobs_dir/$digest_path" 2>/dev/null
            )
          done
          sudo mkdir -p "$publish_manifests_dir/$challenge_slug"
          printf '%s\n' "$image_id" | sudo tee "$publish_manifests_dir/$challenge_slug/latest" >/dev/null
        done < <(
          docker image ls --filter "label=pwncollege.challenge" --no-trunc --quiet \
            | xargs -r docker image inspect --format '{{.Id}} {{index .Config.Labels "pwncollege.challenge"}}'
        )

        echo "::group::rclone blobs"
        rclone copy "$publish_blobs_dir" "r2:${R2_BUCKET_NAME}/blobs" --ignore-existing --config /dev/null --stats-one-line --stats-log-level NOTICE
        echo "::endgroup::"
        echo "::group::rclone manifests"
        rclone copy "$publish_manifests_dir" "r2:${R2_BUCKET_NAME}/manifests" --config /dev/null --stats-one-line --stats-log-level NOTICE
        echo "::endgroup::"

    - name: Update dojo
      if: ${{ hashFiles(format('challenges/{0}/dojo.yml', matrix.challenges)) != '' }}
      env:
        CHALLENGES_DIR: challenges/${{ matrix.challenges }}
        DOJO_URL: https://pwn.college
        DOJO_TOKEN: ${{ secrets.DOJO_TOKEN }}
      run: ./tools/dojo/update-dojo --registry challenges.pwn.college "$CHALLENGES_DIR/dojo.yml"

    - name: Report runtime storage
      if: always()
      uses: ./.github/actions/report-runtime-storage
