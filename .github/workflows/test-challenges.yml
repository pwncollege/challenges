name: Test Challenges

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      test_all:
        description: 'Test all challenges'
        required: false
        default: true
        type: boolean
  schedule:
    - cron: '0 2 * * *'  # Daily at 2 AM UTC

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.changed-challenges.outputs.matrix }}
      has-changes: ${{ steps.changed-challenges.outputs.has-changes }}

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Fetch all history for proper diff

    - name: Install uv
      uses: astral-sh/setup-uv@v7
      with:
        cache-dependency-glob: ci/list-challenges

    - name: Get challenges to test
      id: changed-challenges
      run: |
        set -euo pipefail

        if [ "${{ github.event_name }}" = "workflow_dispatch" ] || [ "${{ github.event_name }}" = "schedule" ]; then
          echo "Collecting all challenges (triggered by ${{ github.event_name }})"
          TABLE=$(./ci/list-challenges)
          MATRIX=$(./ci/list-challenges --format matrix)
        else
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            REF="${{ github.event.pull_request.base.sha }}"
          else
            REF="${{ github.event.before }}"
          fi

          if [ -z "$REF" ] || [ "$REF" = "0000000000000000000000000000000000000000" ]; then
            REF=$(git hash-object -t tree /dev/null)
          fi

          echo "Collecting challenges modified since $REF"
          TABLE=$(./ci/list-challenges --modified-since "$REF")
          MATRIX=$(./ci/list-challenges --modified-since "$REF" --format matrix)
        fi

        echo "Challenges to test:"
        echo "$TABLE"

        if [ "$MATRIX" = '{"group":[],"include":[]}' ]; then
          echo "No challenges to test"
          echo "has-changes=false" >> "$GITHUB_OUTPUT"
        else
          echo "has-changes=true" >> "$GITHUB_OUTPUT"
        fi

        echo "matrix=$MATRIX" >> "$GITHUB_OUTPUT"

  test-challenges:
    needs: detect-changes
    if: needs.detect-changes.outputs.has-changes == 'true'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false  # Continue testing other challenges even if one fails
      matrix: ${{ fromJson(needs.detect-changes.outputs.matrix) }}

    steps:
    - uses: actions/checkout@v4

    - name: Install uv
      uses: astral-sh/setup-uv@v7
      with:
        cache-dependency-glob: build

    - name: Set up Docker
      uses: docker/setup-buildx-action@v3

    - name: Install git-crypt
      run: |
        sudo apt-get update && sudo apt-get install -y git-crypt

    - name: Remove encrypted directories
      run: |
        # Find and remove directories containing encrypted files using git-crypt status (these cannot be tested currently)
        git crypt status -e | sed -e "s/ *encrypted: //" | xargs dirname | xargs rm -rf

    - name: Test challenges in group
      env:
        GROUP_CHALLENGES: ${{ matrix.challenges }}
        GROUP_NAME: ${{ matrix.group }}
      run: |
        set -euo pipefail

        GROUP_CHALLENGES_CONTENT="${GROUP_CHALLENGES:-}"

        if [ -z "$GROUP_CHALLENGES_CONTENT" ]; then
          echo "No challenges queued"
          exit 0
        fi

        readarray -t CHALLENGE_LIST <<< "$GROUP_CHALLENGES_CONTENT"

        if [ "${#CHALLENGE_LIST[@]}" -eq 0 ]; then
          echo "No challenges queued"
          exit 0
        fi
        TOTAL="${#CHALLENGE_LIST[@]}"

        if [ "$TOTAL" -eq 0 ]; then
          echo "No challenges queued"
          exit 0
        fi

        GROUP_LABEL="${GROUP_NAME:-unknown}"
        echo "::group::Group summary for $GROUP_LABEL"
        echo "Group: $GROUP_LABEL"
        echo "Total challenges: $TOTAL"
        echo "Challenges in this group:"
        for challenge in "${CHALLENGE_LIST[@]}"; do
          echo "- $challenge"
        done
        echo "::endgroup::"

        echo "Group: $GROUP_NAME"
        echo "Testing ${#CHALLENGE_LIST[@]} challenge(s)"

        PASSED=()
        FAILED=()

        CURRENT=0
        BAR_WIDTH=20
        for challenge in "${CHALLENGE_LIST[@]}"; do
          CURRENT=$((CURRENT + 1))
          FILLED=$((CURRENT * BAR_WIDTH / TOTAL))
          EMPTY=$((BAR_WIDTH - FILLED))
          FILLED_BAR=$(printf '%*s' "$FILLED" '' | tr ' ' '#')
          EMPTY_BAR=$(printf '%*s' "$EMPTY" '' | tr ' ' '.')
          BAR="${FILLED_BAR}${EMPTY_BAR}"
          echo "::group::[$BAR] [${CURRENT}/${TOTAL}] Testing $challenge"
          echo "Testing $challenge"
          echo "Progress: [$BAR] (${CURRENT}/${TOTAL})"
          if OUTPUT=$(./build "./challenges/$challenge" 2>&1); then
            echo "✓ $challenge passed"
            PASSED+=("$challenge")
          else
            printf '%s\n' "$OUTPUT"
            echo "::error::✗ $challenge failed"
            FAILED+=("$challenge")
          fi
          echo "::endgroup::"
        done

        PASSED_COUNT="${#PASSED[@]}"
        FAILED_COUNT="${#FAILED[@]}"

        if [ -n "${GITHUB_STEP_SUMMARY:-}" ]; then
          {
            echo "### Results for group \`${GROUP_LABEL}\`"
            echo
            echo "- Total challenges: $TOTAL"
            echo "- Passed: $PASSED_COUNT"
            echo "- Failed: $FAILED_COUNT"
            echo
            echo "<details><summary>Passed challenges</summary>"
            echo
            if [ "$PASSED_COUNT" -eq 0 ]; then
              echo "*(none)*"
            else
              for challenge in "${PASSED[@]}"; do
                echo "- \`$challenge\`"
              done
            fi
            echo
            echo "</details>"
            echo
            echo "<details><summary>Failed challenges</summary>"
            echo
            if [ "$FAILED_COUNT" -eq 0 ]; then
              echo "*(none)*"
            else
              for challenge in "${FAILED[@]}"; do
                echo "- \`$challenge\`"
              done
            fi
            echo
            echo "</details>"
            echo
          } >> "$GITHUB_STEP_SUMMARY"
        fi

        if [ "$FAILED_COUNT" -gt 0 ]; then
          exit 1
        fi
