name: Test Challenges

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      test_all:
        description: 'Test all challenges'
        required: false
        default: true
        type: boolean
  schedule:
    - cron: '0 2 * * *'  # Daily at 2 AM UTC

jobs:
  detect-challenges:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.challenge-matrix.outputs.matrix }}
      modified-since: ${{ steps.modified-since.outputs.ref }}

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Install uv
      uses: astral-sh/setup-uv@v7
      with:
        cache-dependency-glob: tools/pwnshop/**

    - name: Determine modified-since ref
      id: modified-since
      run: |
        set -euo pipefail
        if [ "${{ github.event_name }}" = "workflow_dispatch" ] || [ "${{ github.event_name }}" = "schedule" ]; then
          echo "ref=" >> "$GITHUB_OUTPUT"
          exit 0
        fi

        if [ "${{ github.event_name }}" = "pull_request" ]; then
          ref="${{ github.event.pull_request.base.sha }}"
        else
          ref="${{ github.event.before }}"
        fi

        if [ "$ref" = "0000000000000000000000000000000000000000" ]; then
          ref=""
        fi

        echo "ref=$ref" >> "$GITHUB_OUTPUT"

    - name: Build challenge matrix
      id: challenge-matrix
      env:
        MODIFIED_SINCE: ${{ steps.modified-since.outputs.ref }}
      run: |
        set -euo pipefail
        challenges="$(./pwnshop list ./challenges --modified-since="$MODIFIED_SINCE")"

        matrix_entries="$(
          printf '%s\n' "$challenges" \
            | cut -d/ -f1 \
            | sort -u \
            | while read -r dir; do printf '{"directory":"challenges/%s"}\n' "$dir"; done \
            | paste -sd, -
        )"
        echo "matrix={\"include\":[${matrix_entries}]}" >> "$GITHUB_OUTPUT"

  test-challenges:
    needs: detect-challenges
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false  # Continue testing other challenges even if one fails
      matrix: ${{ fromJson(needs.detect-challenges.outputs.matrix) }}

    steps:
    - uses: actions/checkout@v4

    - name: Install uv
      uses: astral-sh/setup-uv@v7
      with:
        cache-dependency-glob: tools/pwnshop/**

    - name: Set up Docker storage
      run: |
        echo "::group::Current disk usage"
        df -h
        echo "::endgroup::"
        sudo systemctl stop docker
        sudo rm -rf /var/lib/docker
        sudo mkdir -p /mnt/docker
        sudo ln -s /mnt/docker /var/lib/docker
        sudo systemctl start docker

    - name: Set up Docker
      uses: docker/setup-buildx-action@v3

    - name: Install git-crypt
      run: |
        sudo apt-get update && sudo apt-get install -y git-crypt

    - name: Remove encrypted directories
      run: |
        # Find and remove directories containing encrypted files using git-crypt status (these cannot be tested currently)
        git crypt status -e | sed -e "s/ *encrypted: //" | xargs dirname | xargs rm -rf

    - name: Test challenges in directory
      env:
        CHALLENGE_DIR: ${{ matrix.directory }}
        MODIFIED_SINCE: ${{ needs.detect-challenges.outputs.modified-since }}
      run: |
        set -euo pipefail
        JOBS=$(( $(nproc) * 2 ))
        echo "::group::Testing challenges in ${CHALLENGE_DIR}"
        ./pwnshop list "$CHALLENGE_DIR" --modified-since="$MODIFIED_SINCE"
        echo "::endgroup::"
        ./pwnshop test --jobs "$JOBS" --modified-since="$MODIFIED_SINCE" "$CHALLENGE_DIR"
