#!/bin/bash

# Generate a random add value (10â€“100) and a random alphanumeric character
ADD_VAL=$((RANDOM % 91 + 10))
CHARSET="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz"
CHAR="${CHARSET:$((RANDOM % 62)):1}"
CHAR_VAL=$(printf '%d' "'$CHAR")
TARGET=$((CHAR_VAL + ADD_VAL))

# Write assembly source
SRC=$(mktemp --suffix=.s)
cat > "$SRC" << EOF
.intel_syntax noprefix
.global _start
_start:
  mov rax, [rsp+16]
  add BYTE PTR [rax], $ADD_VAL
  cmp BYTE PTR [rax], $TARGET
  jne fail
  mov BYTE PTR [rsp], '/'
  mov BYTE PTR [rsp+1], 'f'
  mov BYTE PTR [rsp+2], 'l'
  mov BYTE PTR [rsp+3], 'a'
  mov BYTE PTR [rsp+4], 'g'
  mov BYTE PTR [rsp+5], 0
  mov rdi, rsp
  mov rsi, 0
  mov rax, 2
  syscall
  mov rdi, rax
  mov rsi, rsp
  mov rdx, 64
  mov rax, 0
  syscall
  mov rdx, rax
  mov rdi, 1
  mov rax, 1
  syscall
  mov rax, 60
  syscall
fail:
  mov rax, 60
  syscall
EOF

# Assemble, link, and set SUID
OBJ=$(mktemp --suffix=.o)
as -o "$OBJ" "$SRC" 2>/tmp/.init.log
ld -o /challenge/reverse-me "$OBJ" 2>>/tmp/.init.log
chmod 4755 /challenge/reverse-me
rm -f "$SRC" "$OBJ"
