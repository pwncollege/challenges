FROM ubuntu:24.04 AS v8-builder

RUN apt-get update && apt-get install -y \
    git curl python3 lsb-release sudo \
    build-essential pkg-config libglib2.0-dev xz-utils patch

RUN git clone https://chromium.googlesource.com/chromium/tools/depot_tools.git /opt/depot_tools
ENV PATH="/opt/depot_tools:${PATH}"

WORKDIR /build
RUN echo "solutions = [{'name': 'v8', 'url': 'https://chromium.googlesource.com/v8/v8.git', 'deps_file': 'DEPS', 'managed': False}]" > .gclient
RUN git clone https://chromium.googlesource.com/v8/v8.git

WORKDIR /build/v8

COPY REVISION /tmp/REVISION
RUN git checkout $(cat /tmp/REVISION)
RUN ln -sf /usr/bin/python3 /usr/bin/python
RUN gclient sync
# Fix Python 3.12 incompatibilities in old V8 bundled dependencies
RUN find third_party -name '*.py' -exec grep -l 'from collections import' {} + 2>/dev/null | \
    xargs -r sed -i 's/from collections import Mapping/from collections.abc import Mapping/g' || true
RUN find third_party -name '*.py' -exec grep -l 'import collections' {} + 2>/dev/null | \
    xargs -r sed -i 's/collections\.Mapping/collections.abc.Mapping/g' || true
# Some V8 revisions pin a toolchain whose bundled libstdc++ is older than Ubuntu 24.04's
# C++ runtime deps (e.g., ICU), causing link failures. Prefer the system libstdc++.
RUN ln -sf /usr/lib/x86_64-linux-gnu/libstdc++.so.6 third_party/llvm-build/Release+Asserts/lib/libstdc++.so.6

COPY args.gn /tmp/args.gn
RUN mkdir -p out/release && cp /tmp/args.gn out/release/args.gn
RUN gn gen out/release
RUN apt-get install -y ninja-build

# Build an unpatched baseline once per (REVISION, args.gn). This layer can be
# reused across many challenges, and makes the subsequent patch build mostly
# incremental instead of a full rebuild.
RUN autoninja -C out/release d8

COPY patch /tmp/patch
RUN git apply /tmp/patch || patch -p1 --fuzz=3 < /tmp/patch

# Re-generate build files in case the patch touched BUILD.gn/torque/etc, then
# rebuild incrementally.
RUN gn gen out/release
RUN autoninja -C out/release d8

FROM ubuntu:24.04

RUN apt-get update && apt-get install -y adduser gcc && rm -rf /var/lib/apt/lists/*

# Legacy builder (DOCKER_BUILDKIT=0) doesn't support ADD's --chmod/--chown flags.
# Use a plain ADD and fix ownership/mode in a separate RUN (works for both).
ADD http://github.com/pwncollege/exec-suid/releases/latest/download/exec-suid /usr/bin/exec-suid
RUN chown 0:0 /usr/bin/exec-suid && chmod 6755 /usr/bin/exec-suid

COPY . /challenge

COPY --from=v8-builder /build/v8/out/release/d8 /challenge/d8
COPY --from=v8-builder /build/v8/out/release/snapshot_blob.bin /challenge/snapshot_blob.bin

RUN gcc -static -o /challenge/catflag /challenge/catflag.c && rm -f /challenge/catflag.c
RUN rm -f /challenge/Dockerfile /challenge/.setup
