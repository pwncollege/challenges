# syntax=docker/dockerfile:1

ARG CHALLENGE_IMAGE="{{ challenge_image }}"
FROM "${CHALLENGE_IMAGE}"

# Save the base image's .init if it exists (will be run later)
RUN if [ -x /challenge/.init ]; then mv /challenge/.init /challenge/.init.base; fi

# https://github.com/pwncollege/official-dojos
WORKDIR /opt/dojos

{% set dojo_repo = challenge_path.split("/")[0] %}
ADD https://github.com/pwncollege/{{ dojo_repo }}.git ./{{ dojo_repo }}

{% if dojo_repo == "software-exploitation-dojo" %}
ADD https://www.dropbox.com/scl/fi/zymtq9sit5qeko0l81ph2/vmlinux3?rlkey=eh89lpb19dhhuxfw7ifvckut1&dl=1 ./software-exploitation-dojo/kernel-exploitation/files/3/vmlinux
ADD https://www.dropbox.com/scl/fi/cfln31ihejxyco1xb4j2o/vmlinux2?rlkey=h2tt3yuo5xrw56hquam98y8gh&dl=1 ./software-exploitation-dojo/kernel-exploitation/files/2/vmlinux
ADD https://www.dropbox.com/scl/fi/uhhjp8yf65p81p31rql1e/vmlinux1?rlkey=jybroi9nsya54ffrevmnk89hg&dl=1 ./software-exploitation-dojo/kernel-exploitation/files/1/vmlinux
ADD https://www.dropbox.com/scl/fi/hkwgmkajzw2rzas068g66/vmlinux0?rlkey=q5kkd5br7ize6n1002ghpprz3&dl=1 ./software-exploitation-dojo/kernel-exploitation/files/0/vmlinux
{% endif %}

WORKDIR /

COPY --chmod=755 <<'EOF' /challenge/.init
#!/bin/bash
set -eou pipefail

if [ ! -d "$CHALLENGE_PATH" ]; then
    echo "[*] Challenge path $CHALLENGE_PATH does not exist!"
    exit 1
fi

[ -e /challenge/.init ] && rm -f /challenge/.init

threshold=$((10 * 1024 * 1024))  # 10 MiB

find -L "$CHALLENGE_PATH" \
    -mindepth 1 -maxdepth 1 ! -name '_*' \
    -size -$((threshold + 1))c \
    -exec cp -aL {} /challenge \;

find -L "$CHALLENGE_PATH" \
    -mindepth 1 -maxdepth 1 ! -name '_*' \
    -type f -size +${threshold}c \
    -exec ln -sf {} /challenge/ \;

instance=$(shopt -s nullglob; set -- "$CHALLENGE_PATH"/_*/; printf '%s' "${1:-}")
if [ -n "$instance" ]; then
    cp -aL "$instance"/. /challenge
fi

chown -R 0:0 /challenge
find -L /challenge -exec chmod 4755 {} \;

# Some legacy challenges expect this to exist (e.g. legacy/linux-luminarium/processes/ps)
mkdir -p /run/dojo/var/root
echo "Legacy challenge unpacked." > /run/dojo/var/root/init.log

# Add challenge.localhost and hacker.localhost to /etc/hosts for web challenges
if ! grep -q "challenge.localhost" /etc/hosts; then
    echo "127.0.0.1 challenge.localhost hacker.localhost" >> /etc/hosts
fi

# Create a user for uid 1000 (used by test runner)
if ! getent passwd 1000 >/dev/null 2>&1; then
    echo "hacker:x:1000:1000::/home/hacker:/bin/bash" >> /etc/passwd
    echo "hacker:x:1000:" >> /etc/group
    mkdir -p /home/hacker
    chown 1000:1000 /home/hacker
fi

# Run the base image's .init if it was saved (e.g., for program-misuse challenges)
# Use set +e because the base .init may try to rm files that don't exist
if [ -x /challenge/.init.base ]; then
    set +e
    /challenge/.init.base
    set -e
fi

# Run the challenge-specific .init if one was copied from the dojo
if [ -x /challenge/.init ]; then
    exec /challenge/.init
fi
EOF

ARG CHALLENGE_PATH="/opt/dojos/{{ challenge_path }}"
ENV CHALLENGE_PATH="${CHALLENGE_PATH}"
