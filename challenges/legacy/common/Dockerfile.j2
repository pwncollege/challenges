# syntax=docker/dockerfile:1

ARG CHALLENGE_IMAGE="{{ challenge_image }}"
FROM "${CHALLENGE_IMAGE}"

# https://github.com/pwncollege/official-dojos
WORKDIR /opt/dojos

{% set dojo_repo = challenge_path.split("/")[0] %}
ADD https://github.com/pwncollege/{{ dojo_repo }}.git ./{{ dojo_repo }}

{% if dojo_repo == "software-exploitation-dojo" %}
ADD https://www.dropbox.com/scl/fi/zymtq9sit5qeko0l81ph2/vmlinux3?rlkey=eh89lpb19dhhuxfw7ifvckut1&dl=1 ./software-exploitation-dojo/kernel-exploitation/files/3/vmlinux
ADD https://www.dropbox.com/scl/fi/cfln31ihejxyco1xb4j2o/vmlinux2?rlkey=h2tt3yuo5xrw56hquam98y8gh&dl=1 ./software-exploitation-dojo/kernel-exploitation/files/2/vmlinux
ADD https://www.dropbox.com/scl/fi/uhhjp8yf65p81p31rql1e/vmlinux1?rlkey=jybroi9nsya54ffrevmnk89hg&dl=1 ./software-exploitation-dojo/kernel-exploitation/files/1/vmlinux
ADD https://www.dropbox.com/scl/fi/hkwgmkajzw2rzas068g66/vmlinux0?rlkey=q5kkd5br7ize6n1002ghpprz3&dl=1 ./software-exploitation-dojo/kernel-exploitation/files/0/vmlinux
{% endif %}

WORKDIR /

COPY --chmod=755 <<'EOF' /challenge/.init
#!/bin/bash
set -eou pipefail

if [ ! -d "$CHALLENGE_PATH" ]; then
    echo "[*] Challenge path $CHALLENGE_PATH does not exist!"
    exit 1
fi

rm /challenge/.init

threshold=$((10 * 1024 * 1024))  # 10 MiB

find -L "$CHALLENGE_PATH" \
    -mindepth 1 -maxdepth 1 ! -name '_*' \
    -size -$((threshold + 1))c \
    -exec cp -aL {} /challenge \;

find -L "$CHALLENGE_PATH" \
    -mindepth 1 -maxdepth 1 ! -name '_*' \
    -type f -size +${threshold}c \
    -exec ln -sf {} /challenge/ \;

instance=$(shopt -s nullglob; set -- "$CHALLENGE_PATH"/_*/; printf '%s' "${1:-}")
if [ -n "$instance" ]; then
    cp -aL "$instance"/. /challenge
fi

chown -R 0:0 /challenge
chmod -RL 4755 /challenge

# Some legacy challenges expect this to exist (e.g. legacy/linux-luminarium/processes/ps)
mkdir -p /run/dojo/var/root
echo "Legacy challenge unpacked." > /run/dojo/var/root/init.log

if [ -x /challenge/.init ]; then
    exec /challenge/.init
fi
EOF

ARG CHALLENGE_PATH="/opt/dojos/{{ challenge_path }}"
ENV CHALLENGE_PATH="${CHALLENGE_PATH}"
